10/18(화) - ㅠㅠ

Q : 아니 나도 스마트포인터 써야댐? 굳이 안써도 괜찮겠지? 근데 코드 따라치기가 좀 귀찮아지는데


오늘은 지형을 좀 띄울건데
띄우기 전에 뭔가 조금 설정을 해놓고 가야할 게 있어서

깊이 버퍼링을 안해놨다
일단 설명부터 하고 갑니당

백버퍼에는 각각의 픽셀의 컬러가 기입이 된다
컬러값 이외에 깊이값도 저장되는 버퍼가 우리에게 필요하다
그래서 백버퍼 크기와 똑같은 크기의 버퍼를 하나 더 만들것
그리고 새로 만든 버퍼에는 z값을 저장할 것, z버퍼라고 한다
z버퍼도 매 프레임마다 최댓값인 1로 클리어를 시킨다
z버퍼 연산이 들어간다 -> z버퍼에 있는 값보다 내 z값이 작아? 그럼 뿌려! 
일케 서순에 상관없이 뿌려도 원하는 결과가 만들어지도록 해야칸다

저거는 무조건 필수임, 이제 저거를 안넣고 한번 뿌리고 넣고 한번 뿌려보겠따
오 안넣고 뿌리니까 늦게뿌린 뒤에있는 새끼가 앞에있는것마냥 보이네
마지막에 뿌린 새끼가 무조건 렌더링되는 방식 -> 페인트 알고리즘 
근데 그러면 안된다, 그러므로 z버퍼를 만들러가시겠지? 안어려웠으면 좋겠는데

아무튼 z버퍼 만들러 코어부터 갑니다잉
z버퍼라는것을하나더만들어서작업을할수있게끔해줘야한다~ z버퍼라는것을 어디서 만들어낼것이느느냐
디바이스가서 ID3D11DepthStencilView m_pDepthStencilView 일케 하나 만들어논다 -> 얘가 만들어지면 버퍼(z?)가 만들어지는거다
그리고 디바이스에 크리에이트렌더타겟뷰마냥 CreateDepthStencilView 함수도 하나 맹글어준다
그리고 Create? CreateDevice? 암튼 저기에서 위에 저거 CreateDepthStencilView 호출이 되게 한다

원래 렌더타겟은 백버퍼를 넘겨받아서 텍스처를 만들어서 뿌리는? 암튼 대충 뭐 그런거인데?
뎁스스텐실뷰는 만들어주질 않습니다 (텍스처를?), 우리가 만들어야함
1. 텍스처를 생성한다
2. 깊이 스텐실 뷰로 생성한다
3. 뷰 적용
4. 깊이 스텐실 뷰 상태 객체 생성해서 적용

ID3D11Texture2D pDSTexture; // 텍스처 생성
m_pd3dDevice->CreateTexture2D(뭐시기저시기) // 암튼 이걸로 텍스처를 실질적으로 만든다
m_pd3dDevice->CreateDepthStencilView(pDSTexutre.Get(), 저시기머시기, m_pDepthStencilView.Get() ) // 위에 만들어놓은 텍스처를 뎁실뷰로 리턴해주는거인듯?

게임코어의 프리렌더에서 OMSetRenderTargets에서 세번재 칸이 뎁스스텐실뷰가 들어가는 칸이었다 ( m_pDepthStencilView.Get() 하믄댐) 

그리고 4번을 위해서 State클래스 가가지고 ID3D11DepthStencilState g_pDefaultDepthStencil 뭐 일케 만들어둔다, 일단 만들어만 두고 만지는건 나중에
-> 아씨 이거 어따가 세팅하셨는데 놓쳤네.. 아닌가? 안하셨나? 몰?루

잠깐쉬었다가어떠신? 어림도없지 ㅋㅋ


아 리사이즈될때 백버퍼가 바뀌면 뎁스텐실버퍼도 싹다 지워져야함, 일단 이건 기억만 하고잇어라


아무튼 이제 텍스처부터 제대로 만들러갈것, 테이블들을 겁나 채워가지고 만들어야댐
이미 만들어진 렌더타겟의 크기를 갖고와서 쓰면 도움이될것시다
아 근데 렌더타겟은 영양가가 없네? 스왑체인에서 뽑아와서 크기를 넘겨준다
MipLevels도 1, ArraySize도 하나, 포맷-> 얘는 포맷이 좀 달라야 합니다 DXGI_FORMAT_R24G8_TYPELESS; -> R24G8인 이유는 세줄밑에 

뎁스버퍼가 아니라 뎁스 스텐실 버퍼인 이유 설명갑니다잉
4바이트 다 쓰는게 아니라 24비트만 z값으로 저장하고, 8비트는 스텐실값으로 쓸것이다

SampleDesc.Count = 1; -> 얘는 묻지도 따지지도 말고 1, 0이면 안된다
Usage = D3D11_USAGE_DEFAULT
바인드플래그가 중요하다 D3D11_BIND_DEPTH_STENCIL
아씨 나머지는 걍 코드긁어 


암튼 텍스처는 만들었고, 크리에이트 뎁실뷰에 들어갈걸 채워야하것는디
포맷 -> 텍스처는 RGB로 가야하지만, 얘는 뎁스스텐실로가야한다 -> DXGI_FORMAT_D24_UNORM_S8_UINT; // UNORM은 정규화 안하겠다라는뜻ㅎ
디멘션 -> 무조건 2차원 -> D3D11_DSV_DIMENSION_TEXTURE2D // DSV는 Depth Stencil View 라는뜻ㅎ
두개 빼고 나머지는 일단 무시를 해놓을것, 지금은 딱히 중요치 않은갑지

이제 뎁스버퍼가 만들어진거임, 근데 프레임마다 초기화를 해줘야댐
디바이스의 프리렌더에서 (선생님은 게임코어의 프리렌더인데, 아몰ㄹ아)
m_pImmediateContext->OMSetRenderTargets(1, &m_pRTV, m_pDSV); // 세번째가 DSV 자리
게임코어프리렌더에서 콘텍스트->클리어뎁스스텐실뷰(엠_피뎁실뷰, D3D11_CLEAR_DEPTH | D3D11_CLEAR_STENCIL , 1.0f , 0) 
// 1은 알거고 2는 뎁스랑 스텐실 다 초기화해라, 3은 뎁스버퍼를 뭘로 초기화할건지, 4는 스텐실버퍼를 뭘로 초기화할건지

상태는 적용안했는데 일단 디폴트로 한번 뿌려보자, 오.. 되는 것 같은데? 되네


스텐실이 뭐느느냐, 설명을 드갑니다잉
종이에 구멍을 뚫어놓고 락카를 뿌리면  그게 스텐실 버퍼다
오로지 스텐실버퍼에만 1로 넣어 그런 명령을 내릴수가 있다, 8비트니까 255까지들어갈수가있다
그리고 나중에 스텐실버퍼가  1인놈만 뿌려 이렇게 할수가있다..


이젠 상태값 조정하는걸로 가봅니다잉
스테이트 클래스의 인잇? 가서 디바이스->크리에이트뎁스스텐실스테이트(뎁스스텐실데스크, 엠_피디폴트뎁스스텐실);
데스크에 들어간거 졸라많네..  위에 세개는 뎁스버퍼를 컨트롤, 밑에 다섯개는 스텐실 버퍼를 컨트롤인데 
지금은 스텐실 버퍼를 컨트롤 안할거니까 위에 세개만 쓸거다 
뎁스인에이블 -> 뎁스기능쓸거냐말거냐인듯? 트루
뎁스라이트마스트 -> 마스크값하고 | 연산이 일어난다... (사실상 곱셉이라고 생각하면 된다), 얘도 왔다갔다 할 수 있어야하는데 일단 지금은 ALL(1)로 해둔다
이번에는 비교함수, 졸라많은데 디폴트는 LESS일거임, LESS_EQUAL로 머 살짞 바꿔줌

디바이스의 어디냐 여기 인잇이냐? 아무튼 디바이스 어딘가의 함수 안에서
콘텍스트->OMSetDepthStencilState(뭐시기, 스텐실 참조값?) // 스텐실 참조값은 지금은 안쓸꺼니까 암거나 해도 상관없음 (0xff) , 나중엔 이걸로 스텐실이 같냐안같냐 체크한다?

어.. 상태값이 하나갖곤 안된다? 게임에서 상태값을 사용을 하려면 대략 2~30개정도는 쓸거시다
그래서 뎁스스텐실을 하나를 더만들어서 사용을해보자~ 이거 쓸일은 거의 없을텐데 그냥 한번 해볼게!
몬가 신기한 결과가 나오네요! 대충 그런갑다 하고 넘어갑시다 ㅎ;

지금 리사이즈에서 몬가몬가가 안되어있다, RTV마냥 DSV도 릴리즈엔드겟어드레스오브 해줘야한다
오 저거만 해주면 되네? 싱기

암튼 여까지가 일단락, z버퍼ㅓㅓㅓ 끘? 
와 이제 책을 좀 보도록할게요
뎁스버퍼의 파이프라인을 보면 비교 따로, z버퍼에 쓰는거 따로 -> 이걸 기억해야한다 (p363, 그림 29-3)




암튼 이제 지형을 만들러 갈건데, 사전작업이 또 필요하?다
클래스를 하나 만들자. 맵, 베이스오브젝트를 상속하는.

빌드 함수 하나 만들고 (쿼드트리때 했던 그런느낌인가)
안에서 가로정점의 개수, 세로정점의 개수만큼 for문을 돌려서 VertexList랑 IndexList에 다이렉트로 넣을것
전체 정점 개수 = iWidth * iHeight
전체 셀 개수 = (iWidth-1) * (iHeight)
전체 페이스 개수 = (iWidth-1) * (iHeight) * 2 	// ??? 이거 좀 그려봐야겠는디

위에 저시기들을 사용해서 버텍스 버퍼랑 인덱스 버퍼를 채워준다 
그리고 베이스오브젝트의 크리에이트 버텍스, 인덱스 버퍼에 조건을 붙여놓는다 (이미 만들어져 있다면 건드리지 마!)

정점의 개수를 나중에 공간분할을 할때 반드시 고려를 해야하는게
항상 2의 n승 +1 개로 사용을 하라 	// (1, 2, 4, 8, 16..)+1
일케 해주면 나중에 공간분할을 할 때 셀이 짤리지 않는다

셀디스턴스로 셀 사이의 거리를 줄 수도 있다


여까지만! 휴~~~~
천천히하시져 ㅋㅋ 2시 언저리에만 끝나면 괘안습니더~~


카메라 제어기능이 이제는 좀 피룡 하다


Q : 아니 근데 저거 Build(1024+1, 1024+1) 하면 셀도 1024 x 1024 아님? 
     왜 절반이라고 하시는것같지 코드 따라가봐야하나 귀찮아죽것네 
